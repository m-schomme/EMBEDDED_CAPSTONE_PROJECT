<!DOCTYPE html>
<html>
<head>
    <title>ESP32 Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/bundle.js"></script>
            <link href='https://fonts.googleapis.com/css?family=Oswald' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
  
    <!-- Mary's Code -->
    <h1 style="font-family: 'Oswald'; text-align: center;">24-HOUR ENERGY USAGE DASHBOARD</h1>

    <div style="display: flex; gap: 20px; height: calc(100vh - 120px);">
        <div style="flex: 1; display: flex; flex-direction: column; gap: 20px;">
            <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                <h3 style="margin: 0 0 10px 0;">CURRENT</h3>
                <div style="flex: 1; position: relative;">
                    <canvas id="currentChart"></canvas>
                </div>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                <h3 style="margin: 0 0 10px 0;">VOLTAGE</h3>
                <div style="flex: 1; position: relative;">
                    <canvas id="voltageChart"></canvas>
                </div>
            </div>
        </div>
        <div style="flex: 2; margin-left: 20px; display: flex; flex-direction: column; min-height: 0;">
            <h3 style="margin: 0 0 10px 0;">POWER & TEMPERATURE</h3>
            <div style="flex: 1; position: relative; min-height: 0;">
                <canvas id="powerTempChart"></canvas>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 15px;">
                <button id="fanBtn" class="control-btn active" onclick="toggleButton('fanBtn')">FAN ON</button> 
                <button id="peltierBtn" class="control-btn active" onclick="toggleButton('peltierBtn')">PELTIER ON</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>

    <script>
        const current = document.getElementById('currentChart').getContext('2d');
        const voltage = document.getElementById('voltageChart').getContext('2d');
        const powerTemp = document.getElementById('powerTempChart').getContext('2d');

        Chart.register(ChartDataLabels);
        new Chart(current, {
            type: 'line',
            data: {
                labels: ['0:00', '4:00', '8:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [
                {
                    label: 'Fan',
                    data: [0.3, 0.5, 0.4, 0.2, 0.6, 0.3, 0.9],
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    pointBackgroundColor: 'rgba(75, 192, 192, 1)'
                },
                {
                    label: 'Peltier',
                    data: [0.2, 0.7, 0.3, 0.7, 0.5, 0.2, 0.8],
                    borderColor: 'rgba(102, 255, 0, 1)',
                    borderWidth: 1,
                    pointBackgroundColor: 'rgba(102, 255, 0, 1)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                        usePointStyle: true,
                        pointStyle: 'rect',
                        pointStyleWidth: 60,
                        }
                    },
                    datalabels: {
                        display: false,
                    },
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: 'Amps',
                        },
                        beginAtZero: true,
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hour',
                        },
                        beginAtZero: true,
                    },
                },
            }
        });
        new Chart(voltage, {
            type: 'line',
            id: 'voltageChart',
            data: {
                labels: ['0:00', '4:00', '8:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [
                {
                    label: 'Fan',
                    data: [3.3, 3.8, 3.5, 3.6, 3.2, 3.9, 3.4],
                    borderColor: 'rgba(153, 102, 255, 1)',
                    borderWidth: 1,
                    pointBackgroundColor: 'rgba(153, 102, 255, 1)'
                },
                {
                    label: 'Peltier',
                    data: [5.0, 4.8, 5.2, 5.1, 4.9, 5.3, 5.0],
                    borderColor: 'rgba(255, 206, 86, 1)',
                    borderWidth: 1,
                    pointBackgroundColor: 'rgba(255, 206, 86, 1)'
                }
            ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                        usePointStyle: true,
                        pointStyle: 'rect',
                        pointStyleWidth: 60
                        }
                    },
                    datalabels: {
                        display: false,
                    },
                },
                scales: {
                    y: {
                            title: {
                                display: true,
                                text: 'Volts',
                            },
                            beginAtZero: true,
                        },
                    x: {
                        title: {
                            display: true,
                            text: 'Hour',
                        },
                        beginAtZero: true,
                    },
                },
            }
        });
        new Chart(powerTemp, {
            type: 'bar',
            data: {
                labels: ['0:00', '4:00', '8:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [
                {
                    label: 'Power',
                    type: 'bar',
                    data: [1.7, 2.1, 1.2, 1.8, 2.3, 1.5, 2.7],
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1,
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    yAxisID: 'y',
                    datalabels: {
                        anchor: 'end',
                        align: 'start',
                        clamp: true,
                        color: 'white',
                        font: {
                            weight: '500',
                            size: 24,
                            family: 'Oswald',
                        },
                        formatter: (value) => value,
                    },
                },
                {
                    label: 'Temperature',
                    type: 'line',
                    data: [68, 70, 66, 72, 75, 69, 78],
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1,
                    pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                    yAxisID: 'y2',
                    datalabels: { display: false,},
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                        usePointStyle: true,
                        pointStyle: 'rect',
                        pointStyleWidth: 60
                        }
                    },
                    datalabels: {
                        display: true,
                    }  
                },
                scales: {
                    y: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'Watts',
                        },
                        beginAtZero: true,
                        },
                    y2: {
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Farenheit',
                        },
                        beginAtZero: true,
                        grid: {
                            drawOnChartArea: false,
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Hour',
                        },
                        beginAtZero: true,
                    },
                }
            }
    });

        // Toast pop ups
        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #333;
                color: white;
                padding: 16px 24px;
                border-radius: 4px;
                z-index: 1000;
                font-family: Oswald;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // button toggle on/off
        function toggleButton(buttonId) {
            const btn = document.getElementById(buttonId);
            const deviceName = buttonId === 'fanBtn' ? 'Fan' : 'Peltier';
            const deviceId = buttonId === 'fanBtn' ? 'fan' : 'peltier';
            
            if (btn.classList.contains('active')) {
                btn.classList.remove('active');
                btn.classList.add('inactive');
                btn.innerText = btn.innerText.replace('ON', 'OFF');
                showToast(`${deviceName} has been turned off`);
                setDevice(deviceId, false);
            } else {
                btn.classList.remove('inactive');
                btn.classList.add('active');
                btn.innerText = btn.innerText.replace('OFF', 'ON');
                showToast(`${deviceName} has been turned on`);
                setDevice(deviceId, true);
            }
        }
    </script>
    <style>
        h1 {
            font-family: Oswald;
            text-align: center;
        }
        h3 {
            font-family: Oswald;
            font-weight: 400;
            text-align: start;
            padding-left: 50;
        }
        .control-btn {
            padding: 12px 24px;
            font-size: 14px;
            font-family: Oswald;
            font-weight: 500;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .control-btn.active {
            background-color: #4CAF50;
            color: white;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }
        .control-btn.active:hover {
            background-color: #45a049;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.6);
        }
        .control-btn.inactive {
            background-color: #cccccc;
            color: #666666;
            box-shadow: none;
        }
        .control-btn.inactive:hover {
            background-color: #b3b3b3;
        }
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>

    <!--  -->
  
    <script>
        const externalUrl = 'http://192.168.1.100/api';  // Replace with actual external URL
        let chart;
        const wsUrl = 'ws://' + location.host + '/ws';
        const socket = new WebSocket(wsUrl);

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updateChartAndPower(data);
            updateStatus(data);
        };

        function updateChartAndPower(data) {
            const totalPowers = data.map(d => parseFloat(d.sys_volts) * (parseFloat(d.fan_amps) + parseFloat(d.pel_amps)));

            if (data.length > 0) {
                const last = data[data.length - 1];
                const power = parseFloat(last.sys_volts) * (parseFloat(last.fan_amps) + parseFloat(last.pel_amps));
                document.getElementById('power').innerText = power.toFixed(2);
            } else {
                document.getElementById('power').innerText = '0';
            }

            if (!chart) {
                const ctx = document.getElementById('chart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => d.datetime),
                        datasets: [
                            { label: 'Sys Volts', data: data.map(d => parseFloat(d.sys_volts)), borderColor: 'red' },
                            { label: 'Fan Status', data: data.map(d => parseInt(d.fan_status)), borderColor: 'orange', stepped: 'before' },
                            { label: 'Fan Amps', data: data.map(d => parseFloat(d.fan_amps)), borderColor: 'blue' },
                            { label: 'Pel Status', data: data.map(d => parseInt(d.pel_status)), borderColor: 'yellow', stepped: 'before' },
                            { label: 'Pel Amps', data: data.map(d => parseFloat(d.pel_amps)), borderColor: 'green' },
                            { label: 'Pel Temp', data: data.map(d => parseFloat(d.pel_temp)), borderColor: 'purple' },
                            { label: 'Total Power (W)', data: totalPowers, borderColor: 'black' }
                        ]
                    },
                    options: {
                        scales: {
                            x: { type: 'time', time: { parser: 'YYYY-MM-DD HH:mm:ss' } }
                        }
                    }
                });
            } else {
                chart.data.labels = data.map(d => d.datetime);
                chart.data.datasets[0].data = data.map(d => parseFloat(d.sys_volts));
                chart.data.datasets[1].data = data.map(d => parseInt(d.fan_status));
                chart.data.datasets[2].data = data.map(d => parseFloat(d.fan_amps));
                chart.data.datasets[3].data = data.map(d => parseInt(d.pel_status));
                chart.data.datasets[4].data = data.map(d => parseFloat(d.pel_amps));
                chart.data.datasets[5].data = data.map(d => parseFloat(d.pel_temp));
                chart.data.datasets[6].data = totalPowers;
                chart.update();
            }
        }

        function updateStatus(data) {
            if (data.length > 0) {
                const last = data[data.length - 1];
                const fanOn = parseInt(last.fan_status) === 1;
                const pelOn = parseInt(last.pel_status) === 1;
                document.getElementById('fanOn').disabled = fanOn;
                document.getElementById('fanOff').disabled = !fanOn;
                document.getElementById('peltierOn').disabled = pelOn;
                document.getElementById('peltierOff').disabled = !pelOn;
            }
        }
        
        async function setDevice(device, state) {
            try {
                await fetch(externalUrl + '/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ device, state })
                });
                // Assume external device will insert updated data shortly, triggering WS update
            } catch (e) {
                console.error('Failed to set device');
            }
        }
        
        document.getElementById('fanOn').onclick = () => setDevice('fan', true);
        document.getElementById('fanOff').onclick = () => setDevice('fan', false);
        document.getElementById('peltierOn').onclick = () => setDevice('peltier', true);
        document.getElementById('peltierOff').onclick = () => setDevice('peltier', false);
        
        // Fallback polling every second if no WS updates (e.g., if no inserts)
        setInterval(() => {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send('refresh');  // Optional: server can ignore or handle to send update
            }
        }, 1000);
    </script>
</body>
</html>